<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ù…Ø³ ÙˆÙ‚Ù…Ø± - Ø§Ù„Ù„Ø¹Ø¨</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="game-page">
    <div class="game-container">
        <div class="game-header">
            <h1>â˜€ï¸ Ø§Ù„Ø´Ù…Ø³ vs Ø§Ù„Ù‚Ù…Ø± ğŸŒ™</h1>
            <div class="level-indicator" id="levelIndicator"></div>
            <div class="game-mode-indicator" id="modeIndicator"></div>
        </div>

        <div class="players-info">
            <div class="player" id="player1">
                <span>â˜€ï¸ Ø§Ù„Ø´Ù…Ø³</span>
            </div>
            <div class="player" id="player2">
                <span>ğŸŒ™ Ø§Ù„Ù‚Ù…Ø±</span>
            </div>
        </div>

        <div class="score">
            <div>Ø§Ù„Ø´Ù…Ø³: <span id="scoreX">0</span></div>
            <div>Ø§Ù„Ù‚Ù…Ø±: <span id="scoreO">0</span></div>
        </div>

        <div class="board" id="board"></div>

        <div class="status" id="status">Ø¯ÙˆØ± Ø§Ù„Ø´Ù…Ø³ â˜€ï¸</div>

        <div class="controls">
            <button class="btn btn-primary" onclick="resetGame()">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn btn-danger" onclick="resetScore()">ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·</button>
            <a href="index.html" class="btn btn-secondary">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>
    </div>

    <div class="music-control">
        <span>ğŸµ</span>
        <button class="music-btn" onclick="toggleMusic()" id="musicBtn">ğŸ”Š</button>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <audio id="winSound">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" type="audio/mpeg">
    </audio>

    <audio id="clickSound">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameMode = urlParams.get('mode') || '2players';
        const aiLevel = parseInt(urlParams.get('level')) || 1;

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameActive = true;
        let scores = { X: 0, O: 0 };
        let musicOn = true;
        let gameDifficulty = aiLevel;

        // Ø¹Ù†Ø§ØµØ± DOM
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const scoreXElement = document.getElementById('scoreX');
        const scoreOElement = document.getElementById('scoreO');
        const player1Element = document.getElementById('player1');
        const player2Element = document.getElementById('player2');
        const levelIndicator = document.getElementById('levelIndicator');
        const modeIndicator = document.getElementById('modeIndicator');
        const bgMusic = document.getElementById('bgMusic');
        const winSound = document.getElementById('winSound');
        const clickSound = document.getElementById('clickSound');
        const musicBtn = document.getElementById('musicBtn');

        // Ø´Ø±ÙˆØ· Ø§Ù„ÙÙˆØ²
        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
        function updateIndicators() {
            if (gameMode === '2players') {
                modeIndicator.textContent = 'ğŸ‘¥ ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø¹ ØµØ¯ÙŠÙ‚';
                player2Element.classList.remove('ai');
                levelIndicator.style.display = 'none';
            } else {
                modeIndicator.textContent = `ğŸ¤– ÙˆØ¶Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${aiLevel}`;
                player2Element.classList.add('ai');
                levelIndicator.textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${aiLevel}/20`;
                levelIndicator.style.display = 'inline-block';
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
        function createBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.setAttribute('data-index', i);
                cell.addEventListener('click', () => handleCellClick(i));
                boardElement.appendChild(cell);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
        function updateBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                if (board[index] === 'X') {
                    cell.textContent = 'â˜€ï¸';
                } else if (board[index] === 'O') {
                    cell.textContent = 'ğŸŒ™';
                } else {
                    cell.textContent = '';
                }
            });
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§Ø¦Ø²
        function checkWinner() {
            for (let condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            if (board.every(cell => cell !== '')) {
                return 'tie';
            }
            return null;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù†Ø´Ø·
        function updateActivePlayer() {
            if (currentPlayer === 'X') {
                player1Element.classList.add('active');
                player2Element.classList.remove('active');
            } else {
                player2Element.classList.add('active');
                player1Element.classList.remove('active');
            }
        }

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ù‚Ø±
        function playClickSound() {
            clickSound.currentTime = 0;
            clickSound.play().catch(e => console.log("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"));
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function handleGameEnd(winner) {
            if (winner === 'X') {
                statusElement.textContent = 'ÙØ§Ø²Øª Ø§Ù„Ø´Ù…Ø³ â˜€ï¸!';
                scores.X++;
                scoreXElement.textContent = scores.X;
                highlightWinner('X');
                winSound.play().catch(e => console.log("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙˆØ²"));
            } else if (winner === 'O') {
                statusElement.textContent = 'ÙØ§Ø² Ø§Ù„Ù‚Ù…Ø± ğŸŒ™!';
                scores.O++;
                scoreOElement.textContent = scores.O;
                highlightWinner('O');
                winSound.play().catch(e => console.log("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙˆØ²"));
            } else if (winner === 'tie') {
                statusElement.textContent = 'ØªØ¹Ø§Ø¯Ù„!';
            }
            
            gameActive = false;
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.add('disabled');
            });
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø¦Ø²Ø©
        function highlightWinner(winner) {
            for (let condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] === winner && board[b] === winner && board[c] === winner) {
                    const cells = document.querySelectorAll('.cell');
                    cells[a].classList.add('winner');
                    cells[b].classList.add('winner');
                    cells[c].classList.add('winner');
                    break;
                }
            }
        }

        // Ø­Ø±ÙƒØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        function aiMove() {
            if (!gameActive || currentPlayer !== 'O') return;

            let emptyCells = board.reduce((acc, cell, index) => {
                if (cell === '') acc.push(index);
                return acc;
            }, []);

            if (emptyCells.length === 0) return;

            let moveIndex;

            // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            switch(true) {
                case (aiLevel <= 5): // Ù…Ø³ØªÙˆÙŠØ§Øª Ø³Ù‡Ù„Ø© - Ø­Ø±ÙƒØ§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                    moveIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    break;
                    
                case (aiLevel <= 10): // Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªÙˆØ³Ø·Ø© - ØªÙ…Ù†Ø¹ Ø§Ù„ÙÙˆØ² Ø£Ø­ÙŠØ§Ù†Ø§Ù‹
                    // 70% ÙØ±ØµØ© Ù„Ù…Ù†Ø¹ Ø§Ù„ÙÙˆØ²
                    if (Math.random() < 0.7) {
                        moveIndex = findBestMove('O');
                        if (moveIndex === null) moveIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    } else {
                        moveIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    }
                    break;
                    
                case (aiLevel <= 15): // Ù…Ø³ØªÙˆÙŠØ§Øª ØµØ¹Ø¨Ø© - ØªØ­Ø§ÙˆÙ„ Ø§Ù„ÙÙˆØ² ÙˆØªÙ…Ù†Ø¹ Ø§Ù„ÙÙˆØ²
                    moveIndex = findBestMove('O');
                    if (moveIndex === null) {
                        moveIndex = findBestMove('X');
                    }
                    if (moveIndex === null) {
                        moveIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    }
                    break;
                    
                default: // Ù…Ø³ØªÙˆÙŠØ§Øª Ø®Ø¨ÙŠØ± - Ø°ÙƒØ§Ø¡ Ù…ØªÙ‚Ø¯Ù…
                    moveIndex = findBestMove('O');
                    if (moveIndex === null) {
                        moveIndex = findBestMove('X');
                    }
                    if (moveIndex === null) {
                        // ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ§Ù„Ø²ÙˆØ§ÙŠØ§
                        const preferredMoves = [4, 0, 2, 6, 8];
                        for (let move of preferredMoves) {
                            if (emptyCells.includes(move)) {
                                moveIndex = move;
                                break;
                            }
                        }
                    }
                    if (moveIndex === null) {
                        moveIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    }
            }

            if (moveIndex !== undefined) {
                setTimeout(() => {
                    board[moveIndex] = 'O';
                    playClickSound();
                    updateBoard();
                    
                    const winner = checkWinner();
                    if (winner) {
                        handleGameEnd(winner);
                    } else {
                        currentPlayer = 'X';
                        statusElement.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø´Ù…Ø³ â˜€ï¸';
                        updateActivePlayer();
                    }
                }, 500); // ØªØ£Ø®ÙŠØ± Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙÙƒÙŠØ±
            }
        }

        // Ø¥ÙŠØ¬Ø§Ø¯ Ø£ÙØ¶Ù„ Ø­Ø±ÙƒØ©
        function findBestMove(player) {
            const emptyCells = board.reduce((acc, cell, index) => {
                if (cell === '') acc.push(index);
                return acc;
            }, []);

            for (let index of emptyCells) {
                board[index] = player;
                if (checkWinner() === player) {
                    board[index] = '';
                    return index;
                }
                board[index] = '';
            }
            return null;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ©
        function handleCellClick(index) {
            if (!gameActive || board[index] !== '') return;
            if (gameMode === 'ai' && currentPlayer === 'O') return; // Ù…Ù†Ø¹ Ø§Ù„Ù„Ø¹Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø¯ÙˆØ± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±

            playClickSound();
            board[index] = currentPlayer;
            updateBoard();

            const winner = checkWinner();
            
            if (winner) {
                handleGameEnd(winner);
            } else {
                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                statusElement.textContent = currentPlayer === 'X' ? 'Ø¯ÙˆØ± Ø§Ù„Ø´Ù…Ø³ â˜€ï¸' : 'Ø¯ÙˆØ± Ø§Ù„Ù‚Ù…Ø± ğŸŒ™';
                updateActivePlayer();

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø¶Ø¯ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ¯ÙˆØ± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
                if (gameMode === 'ai' && currentPlayer === 'O' && gameActive) {
                    aiMove();
                }
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
        function resetGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            gameActive = true;
            statusElement.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø´Ù…Ø³ â˜€ï¸';
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.classList.remove('winner', 'disabled');
            });
            
            updateBoard();
            updateActivePlayer();
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø·
        function resetScore() {
            scores = { X: 0, O: 0 };
            scoreXElement.textContent = '0';
            scoreOElement.textContent = '0';
            resetGame();
        }

        // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
        function toggleMusic() {
            musicOn = !musicOn;
            if (musicOn) {
                bgMusic.play();
                musicBtn.textContent = 'ğŸ”Š';
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'ğŸ”ˆ';
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        createBoard();
        updateIndicators();
        updateActivePlayer();

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
        document.addEventListener('click', function initMusic() {
            if (musicOn && bgMusic.paused) {
                bgMusic.play().catch(e => console.log("Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰"));
            }
        }, { once: true });
    </script>
</body>
</html>